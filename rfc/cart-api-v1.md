# Version 1

| Issue | Status |
| ----- | ------ |
| #88   | Draft  |

## Data Models

### `Cart`
| Property | Type | Description | Note |
| --- | --- | --- | --- |
| `id` | UUID | Cart ID, auto-generated by the web API | - |
| `user_id` | UUID | The ID of the user that creates the collection | - |
| `cart_name` | `str` | Cart Name: If it is `NULL`, the cart is the default one for a corresponding user. | **NEED MORE DISCUSSION** |
| `default` | `bool` | Flag to indicate whether this cart is the default one for a corresponding user (`False` by default) | **NEED MORE DISCUSSION** |

For the details on the default cart, see `GET /resources/carts/{id}`.

### `CartItem`
| Property | Type | Description |
| --- | --- | --- |
| `id` | `str` | Cart Item ID, hashed by the combination of `` |
| `cart_id` | UUID | Associated `Cart.id` |
| `entity_id` | UUID | Entity ID |
| `entity_type` | `str` | Entity Type | **TODO:** Need to confirm which model should retain this information. |
| `bundle_uuid` | UUID | Bundle ID |
| `bundle_version` | `str` | Bundle Version |

> Cart Item ID is a hash string of the combination of `cart_id`, `entity_id`, `bundle_uuid`, `bundle_version`. The hash algorithm is probably `sha256` but it is not finalized.

## Web API Specification

Please note that:
1. All endpoints are protected by **a bearer token** ([RFC 6750](https://tools.ietf.org/html/rfc6750)).
  * For the initial release,
    * the bearer token can be anything that we use to identify a user *until the web service integrates with the auth service (`https://auth.{DEPLOYMENT_STAGE}.data.humancellatlas.org`, [docs](https://allspark.dev.data.humancellatlas.org/dcp-ops/docs/wikis/Security/Authentication%20and%20Authorization/Setting%20up%20DCP%20Auth))*, and
    * the client will generate a version 4 UUID string as dubbed as session ID (and the backend will treat the session ID as user ID) and the base64-encoded string of that UUIDÂ will be a bearer token.

2. For CRUD endpoints,
  * All CRUD endpoints take JSON request body on `POST` and `PUT`/`PATCH` requests.
  * `id` is not required as either the ID will be auto-generated by the endpoint on `POST` request, or the ID is given on the URL and immutable on `PUT`/`PATCH` request.
  * Generally, the response on `GET` request will return a single JSON object of the corresponding model if the ID is specified or the list of JSON object otherwise. *There will be some exceptions.*
  * For `PUT` and `PATCH` requests, if `id` in the URL path and `id` in the request body are different, the endpoint may respond with **HTTP 412** without doing anything (preferred), or **HTTP 200** without updating the ID of the corresponding entity.

3. Generally, all endpoints may respond different HTTP status codes according to the given scenario, unless specified otherwise.

| HTTP Status Code | Condition | Notes |
| --- | --- | --- |
| 200 | Everything is ok. | Default status code |
| 401 | The bearer token is invalid or not present. | - |
| 404 | Resource not found | Used on `GET` and `PUT` only |
| 405 | Method not allowed | AWS API Gateway will handle this automatically. |
| 409 | Data integrity error, e.g., supposing that item `i_1` is in cart `c_1`, the client mistakenly request to delete item `i_1` from cart `c_2`. | This is more commonly used in `PUT` and `DELETE` requests. |
| 410 | Resource no longer existed | Used on `DELETE` only |
| 412 | Invalid input / precondition failed | Requires input validation |

#### CRUD APIs for `Cart`

| Method | Path | Description |
| --- | --- | --- |
| `POST` | `/resources/carts/` | Create a new (non-default) cart |
| `GET` | `/resources/carts/` | Retrieve a list of carts |
| `GET` | `/resources/carts/{id}` | Retrieve a single cart (see more detail below) |
| `PUT` | `/resources/carts/{id}` | Update the cart (see more detail below) |
| `DELETE` | `/resources/carts/{id}` | Delete a single cart (see more detail below) |

#### `GET /resources/carts/{id}`

Retrieve a single cart.

##### Response

Instead of returning `Cart` information, the response will be also returning the list of associated `CartItem`, as shown below:

```javascript
{
    id: str, // Cart ID
    cart_name: str,
    default: bool,
    items: List[CartItem] // Each CartItem object will not have `cart_id`.
}
```

##### Default Cart

The default cart is a special case and will be given back to the client ONLY IF `id` is `default` (all lowercase).

* `default` is **the alias ID** of the default cart belonging to the session user.
  * The actual ID of default cart will be returned in the response body.
  * This ID is only used in this endpoint.
* When the default cart is not available, the default cart will be created and return in the same request.

Here is the pseudo code for the request handler.

```python
# Pseudo code: Request Handler
def retrieve_one_cart(id: UUID):
    # Define: bearer_token is the request bearer token
    if id == 'default':
        cart = cart_repository.get_default(user_id = bearer_token)

        if not cart:
            # Either this or: cart = cart_repository.create(user_id = bearer_token, cart_name = '')
            cart = cart_repository.create(user_id = bearer_token, cart_name = '', default = True)
    else:
        cart = cart_repository.get(id)

    return dict(id=cart.id,
                cart_name=cart.cart_name,
                entity_type=cart.entity_type,
                default=cart.default,
                items=cart_item_repository.find_many_by_cart_id(cart.id))
```

Here is the sample request.

```
GET /resources/carts/default
Authorization: Bearer 261e1aea-82c9-4e38-a879-e2e02ef236a5
```

Here is the sample response.

```javascript
{
    id: "6b801de6-11d4-46c0-aed1-ca2110aa7d3c"
    cart_name: "",
    default: true,
    items: [...]
}
```

#### `PUT /resources/carts/{id}`

Here is the request body.

```javascript
{
    cart_name: str // Required
}
```

and the response is basically the JSON representation of `Cart`.

#### `DELETE /resources/carts/{id}`

* The endpoint will only delete the target cart if the user creates the target cart and responds with **HTTP 200**.
  * Otherwise, the endpoint must respond with **HTTP 403**.
* The endpoint will respond **HTTP 410** (gone) if the cart is unknown.

### CRUD APIs for `CartItem`

| Method | Path | Description |
| --- | --- | --- |
| `POST` | `/resources/carts/{cart_id}/items/` | Create a new cart item |
| `DELETE` | `/resources/carts/{cart_id}/items/{id}` | Delete a single cart item |

#### `POST /resources/carts/{cart_id}/items/`

| Param Type | Param Name | Association |
| --- | --- | --- |
| URL Path | `cart_id` | `Cart.id` |

* The request body will be similar to `CartItem` without `cart_id`.
* The endpoint will also respond **HTTP 409** if the corresponding cart is unknown.

> May need a new field to store SHA1 hash on the item data for quick check.

#### `DELETE /resources/carts/{cart_id}/items/{item_id}`

| Param Type | Param Name | Association |
| --- | --- | --- |
| URL Path | `cart_id` | `Cart.id` |
| URL Path | `item_id` | `CartItem.id` |

* The endpoint will also respond **HTTP 409** if the corresponding cart is unknown.
